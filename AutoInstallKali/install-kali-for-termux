#!/data/data/com.termux/files/usr/bin/bash -e
# ç‰ˆæƒæ‰€æœ‰ Â©2018 Hax4Us ä¿ç•™æ‰€æœ‰æƒåˆ© ğŸŒ ğŸŒ ğŸŒ ğŸŒ ğŸ—º
# https://hax4us.com
# ä¿®å¤ @https://github.com/lutherping
################################################################################

# é¢œè‰²è®¾ç½®
red='\033[1;31m'
yellow='\033[1;33m'
blue='\033[1;34m'
reset='\033[0m'

# æ¸…ç†å·¥ä½œï¼Œç§»é™¤æ‰€æœ‰åä¸º "kali*" çš„ç›®å½•
pre_cleanup() {
        find $HOME -name "kali*" -type d -exec rm -rf {} \; || :
} 

# æ¸…ç†å·¥ä½œï¼Œç§»é™¤æ‰€æœ‰åä¸º "kalifs*" çš„æ–‡ä»¶
post_cleanup() {
        find $HOME -name "kalifs*" -type f -exec rm -rf {} \; || :
} 

# è®¾ç½® Chroot ç±»å‹
setchroot() {
    printf "$blue è®¿é—® https://kali.download/nethunter-images/current/rootfs/ æŸ¥çœ‹é€‚åˆæ‚¨æ‰‹æœºçš„ Chroot ç‰ˆæœ¬\n"
    printf "è¯·è¾“å…¥æ•°å­—é€‰æ‹© Chroot ç±»å‹ï¼š\n"
    printf "[1] full\n"
    printf "[2] minimal\n"
    printf "[3] nano\n"
    
    read -p "è¯·è¾“å…¥æ‚¨çš„é€‰æ‹© (1/2/3): " choice

    case $choice in
        1)
            chroot="full"
            ;;
        2)
            chroot="minimal"
            ;;
        3)
            chroot="nano"
            ;;
        *)
            printf "$red é€‰æ‹©æ— æ•ˆï¼Œè¯·è¾“å…¥ 1ã€2 æˆ– 3.\n"
            exit 1
            ;;
    esac
    
    echo "å·²é€‰æ‹© Chroot ç±»å‹: $chroot"
}


# å¤„ç†æœªçŸ¥æ¶æ„çš„æƒ…å†µ
unknownarch() {
        printf "$red"
        echo "[*] æœªçŸ¥æ¶æ„ :("
        printf "$reset"
        exit
}

# æ£€æµ‹ç³»ç»Ÿæ¶æ„ä¿¡æ¯
checksysinfo() {
        printf "$blue [*] æ£€æŸ¥ä¸»æœºæ¶æ„ ..."
        case $(getprop ro.product.cpu.abi) in
                arm64-v8a)
                        SETARCH=arm64
                        ;;
                armeabi|armeabi-v7a)
                        SETARCH=armhf
                        ;;
                *)
                        unknownarch
                        ;;
        esac
        echo "æ£€æµ‹åˆ°çš„æ¶æ„: $SETARCH"
}

# æ£€æŸ¥æ‰€éœ€çš„åŒ…æ˜¯å¦å·²å®‰è£…
checkdeps() {
        printf "${blue}\n"
        echo " [*] æ›´æ–° apt ç¼“å­˜..."
        apt update -y &> /dev/null
        echo " [*] æ£€æŸ¥æ‰€æœ‰æ‰€éœ€çš„å·¥å…·..."

        for i in proot tar axel; do
                if [ -e $PREFIX/bin/$i ]; then
                        echo "  â€¢ $i å·²å®‰è£…"
                else
                        echo "å®‰è£… ${i}..."
                        apt install -y $i || {
                                printf "$red"
                                echo " é”™è¯¯ï¼šè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ– apt\n é€€å‡º..."
                                printf "$reset"
                                exit
                        }
                fi
        done
        apt upgrade -y
}

# æ ¹æ®æ¶æ„è®¾ç½®ä¸‹è½½ URL
seturl() {
        URL="http://kali.download/nethunter-images/current/rootfs/kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz"
}

# ä¸‹è½½ tar æ–‡ä»¶
gettarfile() {
        printf "$blue [*] è·å– tar æ–‡ä»¶...$reset\n\n"
        DESTINATION=$HOME/kali-${SETARCH}
        seturl
        mkdir -p $DESTINATION
        cd $HOME
        rootfs="kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz"
        if [ ! -f "$rootfs" ]; then
            axel ${EXTRAARGS} --alternate "$URL"
        else
            printf "${red}[!] å·²å­˜åœ¨ä¸‹è½½çš„é•œåƒï¼Œå¦‚é•œåƒæŸåæˆ–æœªå®Œå…¨ä¸‹è½½ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤å¹¶é‡æ–°ä¸‹è½½ã€‚$reset\n\n"
        fi
}

# ä¸‹è½½ SHA æ ¡éªŒæ–‡ä»¶
getsha() {
        printf "\n${blue} [*] è·å– SHA ... $reset\n\n"
        if [ -f kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz.sha512sum ]; then
            rm kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz.sha512sum
        fi
        axel ${EXTRAARGS} --alternate "http://kali.download/nethunter-images/current/rootfs/kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz.sha512sum" -o kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz.sha512sum
}

# æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
checkintegrity() {
        printf "\n${blue} [*] æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§...\n"
        echo " [*] è‹¥å®Œæ•´æ€§æ ¡éªŒå¤±è´¥ï¼Œè„šæœ¬å°†ç«‹å³ç»ˆæ­¢"
        printf ' '
        sha512sum -c kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz.sha512sum || {
                printf "$red æŠ±æ­‰ :( ä¸‹è½½çš„æ–‡ä»¶å·²æŸåæˆ–æœªå®Œå…¨ä¸‹è½½ï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬\n${reset}"
                exit 1
        }
}

# è§£å‹ tar æ–‡ä»¶
extract() {
        printf "$blue [*] è§£å‹ä¸­... $reset\n\n"
        proot --link2symlink tar -xvf $HOME/kali-nethunter-rootfs-${chroot}-${SETARCH}.tar.xz -C $HOME 2> /dev/null || {
            printf "$red è§£å‹è¿‡ç¨‹å‡ºç°é—®é¢˜ã€‚è¯·æ£€æŸ¥ tar æ–‡ä»¶ï¼Œå·²ç»å¿½ç•¥ã€‚\n"
            mv $HOME/chroot/kali-${SETARCH} $HOME
        }
}

# åˆ›å»ºç™»å½•è„šæœ¬
createloginfile() {
        bin=${PREFIX}/bin/kali
        cat > $bin <<- EOM
#!/data/data/com.termux/files/usr/bin/bash -e
unset LD_PRELOAD
if [ ! -f $DESTINATION/root/.version ]; then
    touch $DESTINATION/root/.version
fi
user=kali
home="/home/\$user"
LOGIN="sudo -u \$user /bin/bash"
if [[ ("\$#" != "0" && ("\$1" == "-r")) ]]; then
    user=root
    home=/\$user
    LOGIN="/bin/bash --login"
    shift
fi

cmd="proot \\
    --link2symlink \\
    -0 \\
    -r ${DESTINATION} \\
    -b /dev \\
    -b /proc \\
    -b $DESTINATION\$home:/dev/shm \\
    -b /sdcard \\
    -b $HOME \\
    -w \$home \\
    /usr/bin/env -i \\
    HOME=\$home TERM="\$TERM" \\
    LANG=\$LANG PATH=/bin:/usr/bin:/sbin:/usr/sbin \\
    \$LOGIN"

args="\$@"
if [ "\$#" == 0 ]; then
    exec \$cmd
else
    \$cmd -c "\$args"
fi
EOM
        chmod 700 $bin
}

# æ‰“å°åˆ†éš”çº¿
printline() {
        printf "${blue}\n"
        echo " #---------------------------------#"
}

# å¼€å§‹å®‰è£…è¿‡ç¨‹
clear
EXTRAARGS=""
if [[ ! -z $1 ]]; then
    EXTRAARGS=$1
    if [[ $EXTRAARGS != "--insecure" ]]; then
                EXTRAARGS=""
    fi
fi

printf "\n${yellow} æ‚¨å³å°†åœ¨ Termux ä¸Šå®‰è£… Kali Nethunterï¼Œæ— éœ€ Root :) å¾ˆé…·\n\n"

pre_cleanup
checksysinfo
checkdeps
setchroot
gettarfile
getsha
checkintegrity
extract
createloginfile
post_cleanup

printf "$blue [*] æ­£åœ¨ä¸ºæ‚¨é…ç½® Kali ..."

# é…ç½® resolv.conf
resolvconf() {
            # åˆ›å»º etc ç›®å½•
             mkdir -p ${DESTINATION}/etc
            # åˆ›å»º resolv.conf æ–‡ä»¶
             printf "\nnameserver 8.8.8.8\nnameserver 8.8.4.4" > ${DESTINATION}/etc/resolv.conf             
} 
resolvconf

# è¿›è¡Œæœ€ç»ˆçš„é…ç½®å·¥ä½œ
finalwork() {
    DESTINATION=$DESTINATION
    SETARCH=$SETARCH
    bash "$HOME/AutoInstallKali/env.sh"
}
 
finalwork

printline
printf "\n${yellow} ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨ Kali Nethunter äº†ï¼Œåœ¨å‘½ä»¤è¡Œè¾“å…¥ 'kali' å³å¯è¿›å…¥ç³»ç»Ÿã€‚ç¥ä½ ç©å¾—æ„‰å¿«ï¼\n"
printline
printline
printf "\n${blue} [*] æç¤º:${yellow} åŸå§‹è„šæœ¬æ¥è‡ª GitHub/Hax4us\n"
printf "  $blue   [*] æç¤º:${yellow} åŸå§‹è„šæœ¬æ¥è‡ª GitHub/Hax4us\n"
printf "  $blue   [*] æç¤º:${yellow} åŸå§‹è„šæœ¬æ¥è‡ª GitHub/Hax4us\n"
printline
printf "$reset"
